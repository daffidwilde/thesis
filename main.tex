\documentclass[12pt,openright,a4paper]{book}

%%% Packages

% Setting up page
\usepackage[a4paper,top=25mm,right=25mm,bottom=25mm,left=40mm]{geometry}
\usepackage{emptypage}

% Mathematics
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{mathptmx}
\usepackage{mathtools}

% Fonts and typesetting
\usepackage{./fonts}
\usepackage{datetime}
    \newdateformat{monthyeardate}{\monthname[\THEMONTH] \THEYEAR}
\usepackage{setspace}
    \onehalfspacing%
\usepackage{enumerate}  % Roman numerals in lists

% Page headers and footers
\usepackage{fancyhdr}
\usepackage{etoolbox}

\renewcommand{\chaptermark}[1]{%
    \markboth{\MakeUppercase{\thechapter.\ #1}}{}  % Number and title only
} 

\fancypagestyle{normal}{  % Used for most pages
    \fancyhf{}
    \fancyhead[LE,RO]{\slshape\leftmark}  % Show chapter title on outer leaf
    \fancyfoot[LE,RO]{\thepage}  % Show page number on outer leaf
    \renewcommand{\headrulewidth}{1pt}
}
\fancypagestyle{chapterstyle}{  % For chapter pages (no need for a header)
    \fancyhf{}
    \fancyfoot[LE,RO]{\thepage}
    \renewcommand{\headrulewidth}{0pt}% Line at the header invisible
}
\patchcmd{\chapter}{\thispagestyle{plain}}{\thispagestyle{chapterstyle}}{}{}


% Images, lists and tables
\usepackage{booktabs}
\usepackage{graphicx}
\usepackage{standalone}
\usepackage{tikz}

% Bibliography and links
\usepackage{float}  % Force hyperref to patch float [for minted]
\usepackage[hidelinks]{hyperref}
\usepackage[numbers]{natbib}

% Algorithms and code blocks
\usepackage[boxruled]{algorithm2e}
\usepackage{xcolor}
\usepackage{tcolorbox}
\usepackage[newfloat,chapter]{minted}

% Captions
\usepackage{caption}


%%% Settings

% Page stuff
\setcounter{tocdepth}{2}

% Maths stuff
\DeclareMathOperator*{\argmin}{arg\,min}
{\theoremstyle{definition}\newtheorem{definition}{Definition}[chapter]}
{\theoremstyle{plain}\newtheorem{theorem}{Theorem}[chapter]}
\DeclarePairedDelimiter\abs{\lvert}{\rvert}%
\DeclarePairedDelimiter\norm{\lVert}{\rVert}%

% Lengths
\newlength{\imgwidth}
\setlength{\imgwidth}{.95\textwidth}
\newlength{\tablewidth}
\setlength{\tablewidth}{.9\textwidth}

% Colours
\definecolor{linenums}{HTML}{4c566a}
\definecolor{sourcebg}{HTML}{d8dee9}
\definecolor{sourcefr}{HTML}{b2bdd1}
\definecolor{usagebg}{HTML}{fdf6e3}
\definecolor{usagefr}{HTML}{eee8d5}

\definecolor{cyan}{RGB}{0, 164, 216}
\definecolor{magenta}{RGB}{226, 62, 138}
\definecolor{deepblue}{RGB}{0,0,0.5}
\definecolor{deepred}{RGB}{0.6,0,0}
\definecolor{deepgreen}{RGB}{0,0.5,0}

% Code snippet stuff
\usemintedstyle{friendly}
\setminted{fontsize=\scriptsize, framerule=\textwidth}
\setmintedinline{fontsize=\normalsize}


%%% Commands and environments

% Code snippets
\SetupFloatingEnvironment{listing}{%
  name={Snippet},
  fileext=lol%
}

\renewcommand{\theFancyVerbLine}{%
    \ttfamily
    \color{linenums}{%
        \scriptsize\oldstylenums{\arabic{FancyVerbLine}}
    }%
    %\hspace{-2em}%  % If using line numbers [LN]
}

\newenvironment{sourcepy}{%
    \VerbatimEnvironment%
    \begin{tcolorbox}[%
        colback=sourcebg,
        colframe=sourcefr,
        %left=2em%  % [LN]
    ]%
    \begin{minted}[%
        bgcolor=sourcebg,
        %linenos=true%  % [LN]
    ]{python}%
}{\end{minted}\end{tcolorbox}}

\newenvironment{usagepy}{%
    \VerbatimEnvironment%
    \begin{tcolorbox}[%
        colback=usagebg,
        colframe=usagefr,
    ]%
    \begin{minted}[bgcolor=usagebg]{python}%
}{\end{minted}\end{tcolorbox}}

\newenvironment{usagesh}{%
    \VerbatimEnvironment%
    \begin{tcolorbox}[
        colback=usagebg,
        colframe=usagefr,
    ]%
    \begin{minted}[bgcolor=usagebg]{console}%
}{\end{minted}\end{tcolorbox}}

% Inputting source
\newcommand{\tikzpath}{}
\newcommand{\inputtikz}[3][\tikzpath]{%
    \begin{figure}[htbp]
        \centering
        \resizebox{\imgwidth}{!}{%
            \input{#1/#2}
        }
        \caption{#3}\label{fig:#2}
    \end{figure}
}

\newcommand{\algpath}{}
\newcommand{\inputalg}[2][\algpath]{%
    \input{#1/#2}\label{alg:#2}
}

\newcommand{\balg}[1][htbp]{%
    \begin{algorithm}[#1]\DontPrintSemicolon
}
\newcommand{\ealg}{\end{algorithm}}

% Bibliography style
\bibliographystyle{abbrvurl}


%%% DOCUMENT %%%

\begin{document}

\newgeometry{margin=25mm}
\input{title.tex}
\restoregeometry%

% Preamble
\frontmatter%
\input{preamble/abstract}
\input{preamble/dedication}
\input{preamble/declaration}
\input{preamble/acknowledgements}
\input{preamble/dissemination}
\tableofcontents%
\listoffigures%
\listoftables%
\listofalgorithms%
\listoflisting%

% Main text
\mainmatter%
\pagestyle{normal}
\input{chapters/intro/main}
\input{chapters/lit/main}
\input{chapters/edo/main}
\input{chapters/matching/main}
\input{chapters/kmodes/main}
\input{chapters/data/main}
\input{chapters/copd/main}
\input{chapters/conclusion}

% Post-text
\bibliography{bibliography.bib}
\input{appendix}

\end{document}
